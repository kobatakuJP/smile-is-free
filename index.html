<!DOCTYPE html>
<html>

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# website: http://ogp.me/ns/websaite#">
    <meta property="og:url" content="http://★ページのURL" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="★SNSで表示されるタイトル" />
    <meta property="og:description" content="★SNSで表示される説明" />
    <meta property="og:image" content="★SNSで表示される画像" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>★タブに表示されるタイトル</title>
    <meta content="★説明を入れる" name="description" />
    <link rel="stylesheet" type="text/css" href="./css/index.css" />
    <style>
        #app {
            position: relative;
        }

        #app * {
            position: fixed;
        }
    </style>
</head>

<body>
    <div id="app">
        <video ref="video" width="400" height="400" @play="onPlay"></video>
        <canvas ref="canvas" width="400" height="400"></canvas>
        <div class="arrow_box" style="left: 200px; position: relative">
            <div style="position: absolute; top:50%;left:50%;transform:translateY(-50%) translateX(-50%);">はい{{cameraComment}}</div>
        </div>
        <img src="img/cameko.png" style="width: 200px; left: 300px; top: 100px;" />
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
    <script src="js/face-api.min.js"></script>
    <span style="position:fixed;bottom:0;right:0;">Powered by <a href="https://github.com/justadudewhohacks/face-api.js"
            target="_blank">face-api.js</a></span>

    <script>
        /** 表情リスト */
        const EXPRESSION_LIST = [
            { id: "angry", word: "怒って～" },
            { id: "disgusted", word: "うんざりして～" },
            { id: "fearful", word: "恐れて～" },
            { id: "happy", word: "笑って～" },
            { id: "neutral", word: "無表情で～" },
            { id: "sad", word: "悲しんで～" },
            { id: "surprised", word: "驚いて～" }
        ]
        new Vue({
            el: '#app',
            data: {
                MODEL_URI: '/js/models',   // 顔認識モデルの場所
                currentWantExpressionID: EXPRESSION_LIST[3].id,
                cameraComment: EXPRESSION_LIST[3].word,
            },
            computed: {
                video() { return this.$refs['video']; },
                canvas() { return this.$refs['canvas']; }
            },
            methods: {
                onPlay() {
                    const video = this.video;
                    const canvas = this.canvas;
                    setInterval(async () => {
                        // 参考URL https://blog.capilano-fw.com/?p=4063
                        // ウェブカメラの映像から顔データを取得
                        const detections = await faceapi.detectAllFaces(
                            this.video,
                            new faceapi.TinyFaceDetectorOptions()
                        )
                            .withFaceLandmarks()
                            .withFaceExpressions();
                        if (this.isOK(detections)) {
                            alert(`${this.currentWantExpressionID}!`)
                        }
                        // 顔データをリサイズ
                        const resizedDetections = faceapi.resizeResults(detections, {
                            width: video.width,
                            height: video.height
                        });
                        // キャンバスに描画
                        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                        faceapi.draw.drawDetections(canvas, resizedDetections);
                        // faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                        faceapi.draw.drawFaceExpressions(canvas, resizedDetections)
                    }, 500);
                },
                updateExpression() {
                    const next = EXPRESSION_LIST[Math.floor(Math.random() * EXPRESSION_LIST.length)];
                    this.currentWantExpressionID = next.id;
                    this.cameraComment = next.word;
                },
                /** 写っている全員が現在指定されている表情になっているか */
                isOK(detections) {
                    console.log("isok")
                    if (detections && detections[0]) {
                        return detections.filter(v => v.expressions[this.currentWantExpressionID] > 0.95).length === detections.length
                    }
                    return false;
                }
            },
            mounted() {
                // 顔モデルをロード
                Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(this.MODEL_URI),
                    faceapi.nets.faceLandmark68Net.loadFromUri(this.MODEL_URI),
                    faceapi.nets.faceExpressionNet.loadFromUri(this.MODEL_URI)
                ])
                    .then(() => {
                        // ウェブカメラへアクセス
                        navigator.mediaDevices.getUserMedia({ video: true })
                            .then((stream) => {
                                this.video.srcObject = stream;
                                this.video.play();
                            });
                    });
            }
        });
    </script>
</body>

</html>